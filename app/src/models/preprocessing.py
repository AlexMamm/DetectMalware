import array
import cv2
import imageio
import numpy as np
import os
import pandas as pd
import pickle


def convert_to_png(filepath):
    with open(filepath,'rb') as file:
        ln = os.path.getsize(filepath)
        width = 256
        rem = ln % width
        a = array.array('B')
        a.fromfile(file, ln - rem)
    g = np.reshape(a, (len(a) // width, width))
    g = np.uint8(g)
    imageio.imsave(filepath + '.png', g)
    orimg = cv2.imread(filepath + '.png')
    img = cv2.resize(orimg, (256,256))
    cv2.imwrite(filepath + '.png', img)
    img = cv2.imread(filepath + '.png', cv2.IMREAD_GRAYSCALE)
    img = img.astype('float32')

    return img


def preprocessing_dataset(root, benign_dir, malware_df_path):
    X_data, y_data = [], []
    df = pd.read_excel(malware_df_path)

    for malware_file,categorie in zip(df['path'],df['categories']):
        print('[*] Preprocessing: ', malware_file)
        if categorie is None:
            continue
        convert_file = convert_to_png(os.path.join(ROOT_DIR, malware_file))

        X_data.append(convert_file)
        y_data.append(categorie)

    for benign_file in os.listdir(benign_dir):
        if benign_file[-4:] != '.png':
            print('[*] Preprocessing: ', benign_file)
            convert_file = convert_to_png(os.path.join(benign_dir, benign_file))

            X_data.append(convert_file)
            y_data.append('benign')

    X = np.array(X_data)
    y = np.array(y_data)

    X = X / 255

    print('Shape dataset: ', X.shape, y.shape)
    pickle.dump(X, open(os.path.join(root, 'models', 'X_data.pickle'), 'wb'))
    pickle.dump(y, open(os.path.join(root, 'models', 'y_data.pickle'), 'wb'))


if __name__ == '__main__':
    ROOT_DIR = '/'.join(os.path.dirname(os.path.abspath(__file__)).split('/')[:-2])
    df_path = os.path.join(ROOT_DIR, 'data', 'vt_report.xlsx')
    benign_dir = os.path.join(ROOT_DIR, 'data/Benign/')
    preprocessing_dataset(ROOT_DIR, benign_dir, df_path)