from fastapi import FastAPI, File, UploadFile
import shutil
import os
import torch
from models.predict_model import predict
from models.preprocessing import convert_to_png
from models.train_model import CNN
import json

app = FastAPI()


@app.get("/")
async def hello_users():
    return {"Hello, User!": "Detect Malware File"}

@app.post("/detect")
def detect_malware(file: UploadFile = File(...)):
    with open(f'{file.filename}','wb') as buffer:
        shutil.copyfileobj(file.file, buffer)

    root = '/'.join(os.path.dirname(os.path.abspath(__file__)).split('/')[:-1])
    predict(root, os.path.join(root,'src',file.filename))
    message = {}
    if os.path.isfile('detect.json'):
        message = json.load(open(os.path.join(root,'src','detect.json'), 'r'))
        os.remove('detect.json')
        os.remove(file.filename)
        if os.path.isfile('unpacked_' + file.filename):
            os.remove('unpacked_' + file.filename)

    return message
