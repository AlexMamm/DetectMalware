from zipfile import ZipFile
import os
import shutil
import pefile
from unpacker import get_pe_packer
import pandas as pd


def recursive_unzip_malware(path,pswd):
    for root, dirs, files in os.walk(path):
        for file in files:
            if file[-4:] == '.zip':
                new_path = '/'.join(root.split('/')[:-2])
                rm_path = '/'.join(root.split('/')[:-1])
                print(new_path,file)
                with ZipFile(os.path.join(root, file)) as zfile:
                    zfile.extractall(new_path, pwd = bytes(pswd,'utf-8'))
                shutil.rmtree(rm_path)

def recursive_unzip_thezoo(path,pswd):
    for root, dirs, files in os.walk(path):
        if root.split('/')[-1] == 'Binaries':
            continue
        for file in files:
            try:
                if file[-4:] == '.zip':
                    print(root,file)
                    with ZipFile(os.path.join(root, file)) as zfile:
                        zfile.extractall(root, pwd = bytes(pswd,'utf-8'))
                    os.remove(os.path.join(root, file))
                else:
                    os.remove(os.path.join(root, file))
            except:
                print('Except! ', root, file)

def remove_pcap_file(path):
    for root, dirs, files in os.walk(path):
        for file in files:
            if file[-5:] == '.pcap':
                print(root,file)
                os.remove(os.path.join(root,file))

def check_pe_file(path):
    for root, dirs, files in os.walk(path):
        for file in files:
            try:
                pe = pefile.PE(os.path.join(root,file))
            except:
                print(root,file)
                os.remove(os.path.join(root,file))

def prepare_dike_dataset():
    df = pd.read_csv('/home/alex/Downloads/DikeDataset-main/labels/malware.csv')
    categories = ['trojan', 'ransomware', 'worm', 'backdoor', 'rootkit', 'downloader']

    list_files = []
    for category in categories:
        list_files.extend(list(df.sort_values(by=category, ascending=False)['hash'][:1000].values))

    path = '/home/alex/Downloads/DikeDataset-main/files/malware/'
    new_path = '/home/alex/Downloads/DikeDataset-main/files/select/'
    for file in os.listdir(path):
        if file[:-4] in list_files:
            path_file = path + file
            packer = get_pe_packer(path_file)
            if packer == 'Not Packer':
                shutil.copy(path + file, new_path + file)

if __name__ == '__main__':
    path = '/home/alex/PycharmProjects/DetectMalware/benign'
    pswd = 'infected'
    check_pe_file(path)

