import requests
import json
import os
import hashlib
import time
import shutil

ROOT_DIR = os.path.dirname(os.path.abspath(__file__))

def calculate_sha256(filename):
    with open(filename, "rb") as f:
        bytes = f.read()
        readable_hash = hashlib.sha256(bytes).hexdigest();
    return readable_hash

def generate_file_list(path):
    with open(os.path.join(ROOT_DIR, 'dataset.list'), 'w') as write_file:
        for root, dirs, files in os.walk(path):
            for file in files:
                if file[-5:] != '.json':
                    write_file.write(os.path.join(root, file) + '\n')


def vt_report(api,filename):
    hashsum = calculate_sha256(filename)
    url = 'https://www.virustotal.com/vtapi/v2/file/report'
    params = {'apikey': api, 'resource': hashsum}
    response = requests.get(url, params=params)

    with open(filename + '.json','w') as file:
        file.write(json.dumps(response.json(), indent=4))
    time.sleep(15)
        

if __name__ == '__main__':
    api = '5ca9bb2b6062f75f079bc890a556195ed13565bc81d362f9e19400a244b1cb52'
    generate_file_list(os.path.join(ROOT_DIR, 'Data/Zoo_Malware'))
    with open(os.path.join(ROOT_DIR, 'dataset.list'),'r') as file:
        file_list = [line.replace('\n','') for line in file.readlines()]

    path = '/home/alex/validation'
    file_list = [os.path.join(path,file) for file in os.listdir(path) if file[-5:] != '.json']
    for i,filename in enumerate(sorted(file_list)[:]):
        print('[{0}] {1}'.format(i,filename))
        if not os.path.exists(os.path.join(path,filename) + '.json'):
            vt_report(api, os.path.join(path,filename))